{% load static %}
{% load date_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="stylesheet" href="{% static "/fontawesome/css/all.css" %}" >
	<link rel="stylesheet" href="{% static "/css/bootstrap.min.css" %}">
	<link rel="stylesheet" href="{% static "/css/style.css" %}"></link>
	<title>{% block title %}Tasks{% endblock %}</title>
	{% block head %}{% endblock %}
</head>
<body>
	<div class="nav bg-dark text-white p-2">
		{% if user.is_authenticated %}
			<p class="m-0">Welcome, {{ user.username }}. Thanks for logging in.</p>
		{% else %}
			<a class="m-0" href="/api-auth/login">Login</a>
		{% endif %}
	</div>
	{% verbatim %}
	<span id="app">
		<div class="container-fluid">
			<div class="row fullheight">
				<div class="col-sm-2 bg-dark">
					<div v-for="queue in queues" v-bind:class="[queue.id == queue_id ? 'bg-primary' : 'bg-secondary', 'row border p-2']">
						<div class="col-sm-12 d-flex cursor-pointer text-white" v-on:click="selectQueue(queue)">
							<span style="margin-right: auto" class="cursor-pointer">{{ queue.title }}</span>
							<div class="btn" v-on:click="showUpdateQueueModal(queue)"><i class="fa fa-pen" ></i></div>
							<div class="btn" v-on:click="showDeleteQueueModal(queue)"><i class="fa fa-times-circle" ></i></div>
						</div>
					</div>
					<div class="row">
						<div class="btn btn-secondary col-sm-12" v-on:click="showCreateQueueModal">Add</div>
					</div>
				</div>
				<div class="col-sm-2 bg-dark">
					<div v-for="task in tasks" v-bind:class="[task.id == task_id ? 'bg-primary' : 'bg-secondary', 'row border p-2']">
						<div class="col-sm-12 d-flex cursor-pointer text-white" v-on:click="selectTask(task)">
							<span style="margin-right: auto" class="cursor-pointer">{{ task.title }}</span>
							<div class="btn" v-on:click="showUpdateTaskModal(task)"><i class="fa fa-pen" ></i></div>
							<div class="btn" v-on:click="showDeleteTaskModal(task)"><i class="fa fa-times-circle" ></i></div>
						</div>
					</div>
					<div class="row">
						<div class="btn btn-secondary col-sm-12" v-on:click="showCreateTaskModal">Add</div>
					</div>
				</div>
				<div class="col-sm-8 bg-info">
					c
				</div>
			</div>
		</div>
		<!-- Modal -->
		<div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="false">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="createModalLabel">{{ form.title }}</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div class="form-group" v-for="field in form.fields">
							<label for="{{ field.name }}">{{ field.name | capitalize }}</label>
							<input type="text" v-model="field.value" class="form-control" v-bind:id="'form_' + field.name" aria-describedby="{{ field.name }}" v-bind:placeholder="'Enter ' + field.name">
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" v-on:click="handleModal(true)">Close</button>
						<button type="button" class="btn btn-primary" v-on:click="handleModal(false)">Save changes</button>
					</div>
				</div>
			</div>
		</div>
	</span>
	{% endverbatim %}*
	<script src="{% static "/js/jquery-3.2.1.min.js" %}"></script>
	<script src="{% static "/js/bootstrap.min.js" %}"></script>
	<script src="{% static "/js/moment-with-locales.min.js" %}"></script>
	<script src="{% static "/js/vue.min.js" %}"></script>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script>
		document.addEventListener("DOMContentLoaded", function(event) {
			axios.defaults.headers.common['X-CSRFTOKEN'] =
				document.querySelector("[name=csrfmiddlewaretoken]").value;
			app = new Vue({
				el: "#app",
				data: {
					queues: [],
					queue_id: null,
					tasks: [],
					task_id: null,
					details: "",
					form: {
						url: "",
						title: "",
						fields: [],
						method: "post"
					}
				},
				mounted () {
					this.listQueues();
				},
				methods: {
					listQueues() {
						self = this;
						axios.get("/api/queues/")
						.then(function (response) {
							self.queues = response.data;
						})
						.catch(function (error) {
							console.log(error);
						});
					},
					listTasks(queue_id) {
						self = this;
						axios.get("/api/queues/" + queue_id + "/tasks/")
						.then(function (response) {
							self.tasks = response.data;
						})
						.catch(function (error) {
							console.log(error);
						});
					},
					selectQueue(queue) {
						this.queue_id = queue.id;
					},
					selectTask(task) {
						this.task_id = task.id;
					},
					showCreateQueueModal() {
						this.form.url = "/api/queues/";
						this.form.title = "Add Queue";
						this.form.method = "post";
						this.form.fields = [
							{name: "title", value: ""}
						];
						jQuery("#createModal").modal("show");
					},
					showUpdateQueueModal(queue) {
						this.form.url = "/api/queues/" + queue.id + "/";
						this.form.title = "Update Queue";
						this.form.method = "put";
						this.form.fields = [
							{name: "title", value: queue.title}
						];
						jQuery("#createModal").modal("show");
					},
					showDeleteQueueModal(queue) {
						this.form.url = "/api/queues/" + queue.id + "/";
						this.form.title = "Delete Queue";
						this.form.method = "delete";
						this.form.fields = [];
						jQuery("#createModal").modal("show");
					},
					showCreateTaskModal() {
						// TODO - tasks should always be created in the context of a queue
						// Method at the other ned needs to change what it does
						this.form.url = "/api/queues/" + this.queue_id + "/tasks/";
						this.form.title = "Add New Task to Queue";
						this.form.method = "post";
						this.form.fields = [
							{name: "title", value: ""},
							{name: "details", value: ""}
						];
						jQuery("#createModal").modal("show");
					},
					showUpdateTaskModal(task) {
						this.form.url = "/api/tasks/";
						this.form.title = "Update Task";
						this.form.method = "put";
						this.form.fields = [
							{name: "title", value: task.title},
							{name: "details", value: task.details}
						];
						jQuery("#createModal").modal("show");
					},
					showDeleteTaskModal(task) {
						this.form.url = "/api/queues/" + queue.id + "/tasks/";
						this.form.title = "Remove Task From Queue";
						this.form.method = "delete";
						this.form.fields = [];
						jQuery("#createModal").modal("show");
					},
					handleModal(close) {
						jQuery("#createModal").modal("hide");
						if (close) {
							return;
						}
						var payload = {};
						for (field of this.form.fields) {
							payload[field.name] = field.value;
						}
						axios({
							method: this.form.method,
							url: this.form.url,
							data: payload
						})
						.then(function (response) {
							if (response.data) {
								// If in list already then just update
								const results = self.queues.filter(q => q.id == response.data.id);
								if (results.length) {
									for (key in response.data) {
										results[0][key] = response.data[key]
									}
									return;
								}
								// Not in the list already so append
								self.queues.push(response.data);
							} else {
								// Assume it's a delete so refresh
								self.listQueues();
							}
						})
						.catch(function (error) {
							console.log(error);
						});
					},
				},
				filters: {
					capitalize: function (value) {
						if (!value) return ''
						value = value.toString()
						return value.charAt(0).toUpperCase() + value.slice(1)
					}
				},
				watch: {
					queue_id: function (val) {
						this.listTasks(val);
					}
				},
			});
		});
	</script>
	{% block bottom %}
		{% csrf_token %}
	{% endblock %}
</body>
</html>